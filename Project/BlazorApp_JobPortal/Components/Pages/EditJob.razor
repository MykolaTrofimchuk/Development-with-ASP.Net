@page "/jobs/edit/{id:int}"
@using JobPortal.BlazorApp.Models
@using JobPortal.BlazorApp.Services
@using System.ComponentModel.DataAnnotations
@inject JobsService JobsService
@inject NavigationManager Navigation

<h3>Редагування вакансії</h3>

@if (model == null)
{
    <p>Loading...</p>
}
else
{
    <EditForm Model="model" OnValidSubmit="Update">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Назва вакансії</label>
            <InputText class="form-control" @bind-Value="model.Title" />
            <ValidationMessage For="@(() => model.Title)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Компанія</label>
            <InputText class="form-control" @bind-Value="model.Company" />
            <ValidationMessage For="@(() => model.Company)" />
        </div>

        <div class="mb-3">
            <label class="form-label">Опис</label>
            <InputTextArea class="form-control" @bind-Value="model.Description" rows="5" />
            <ValidationMessage For="@(() => model.Description)" />
        </div>

        <button type="submit" class="btn btn-primary">Зберегти зміни</button>
        <a href="/jobs/@Id" class="btn btn-secondary">Скасувати</a>
    </EditForm>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private JobEditModel? model;

    // Клас моделі для форми редагування
    class JobEditModel
    {
        [Required]
        public string Title { get; set; } = "";
        [Required]
        public string Description { get; set; } = "";
        [Required]
        public string Company { get; set; } = "";
    }

    protected override async Task OnInitializedAsync()
    {
        var jobDto = await JobsService.GetJob(Id);

        // Переносимо дані з DTO в модель форми
        model = new JobEditModel
            {
                Title = jobDto.Title,
                Description = jobDto.Description,
                Company = jobDto.Company
            };
    }

    private async Task Update()
    {
        if (model == null) return;

        var jobToUpdate = new JobDto
            {
                Id = Id, // Важливо передати ID
                Title = model.Title,
                Description = model.Description,
                Company = model.Company
            };

        await JobsService.UpdateJob(jobToUpdate);
        Navigation.NavigateTo($"/jobs/{Id}"); // Повертаємось на сторінку деталей
    }
}